<div class="overlay">
    <nav>
        <div class="nav-left" style="align-items: center; width: 10%; display: flex; background: #00000000;">
            <img src="/static/logo.png" alt="My App Logo" class="logo" />
        </div>

        <div class="nav-right"
            style="width:90%; display: flex; background: #dc464600; justify-content: right; height: 50px; position: relative;">
            <div class="searchbar"
                style="width: 80%; background: #00000000; display: flex; align-items: center; justify-content: center;">
                <input type="search" name="" id="" placeholder="Search Anything..."
                    style="width: 50%; height: 30px; border-radius: 5px; border: none; padding: 5px; background: #acacac23;">
            </div>
            <!-- Profile Box -->
            <div class="profile_box"
                style="  background: #9d7b7b00; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid rgba(0, 0, 0, 0.077);">
                <p style="font-size: 10px; margin-left: 5px; margin-right: 6px;">{{ user.displayName }}</p>
                <p style="margin-right: 10px; font-size: 10px; margin-left: 5px; margin-top: 5px;">{{ user.mail }}</p>
            </div>

            <!-- Profile Picture -->
            <div class="profile-container" style="position: relative;">
                <!-- <img src="{{ photo }}" alt="Profile Picture" class="profile-pic" width="50" height="50" style="border-radius:50%; cursor: pointer; margin-right: 10px; background:#fa8383;"> -->
                <img id="profile-photo" src="/static/default-avatar.png"
                    style="width:45px; height:45px; border-radius:50%;">

                <script>
                    async function loadProfilePhoto() {
                        try {
                            const token = "{{ session['access_token'] }}"  // token stored in session during login
                            if (!token) return;

                            const response = await fetch("https://graph.microsoft.com/v1.0/me/photo/$value", {
                                headers: { "Authorization": `Bearer ${token}` }
                            });

                            if (response.ok) {
                                const blob = await response.blob();
                                const url = URL.createObjectURL(blob);
                                document.getElementById("profile-photo").src = url;
                            }
                        } catch (err) {
                            console.error("Failed to load profile photo", err);
                        }
                    }

                    // Call on page load
                    loadProfilePhoto();
                </script>

                <!-- Dropdown Card -->
                <div id="profile-card" class="profile-card hidden">
                    <div class="profile-card-header">
                        <!-- <img src="{{ photo }}" alt="Profile Picture" class="profile-thumb"> -->
                        <div>
                            <h4>{{ user.displayName }}</h4>
                            <p>{{ user.mail or "User" }}</p>
                        </div>
                    </div>
                    <div class="profile-card-body">
                        <a href="/profile" class="card-link">View Full Profile</a>
                        <a href="/logout" class="card-link logout">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar (same as before) -->
    <div class="sidebar">
        <ul>
            <div class="line"><span>Main Menu</span></div>
            <li><a href="dashboard"><img src="/static/icons/dashboard.png" alt=""> Dashboard</a></li>


            {% if is_admin(user.mail or user.userPrincipalName) %}
            <div class="line"><span>Teams</span></div>
            <li><a href="/teams"><img src="/static/icons/sales.png" alt="">Pre-sales</a></li>
            <li><a href="/bd"><img src="/static/icons/bd.png" alt="">Business Development</a></li>
            <li><a href="/cs"><img src="/static/icons/cs.png" alt="">Customer Success</a></li>
            <div class="line"><span>Business Management</span></div>
            <li><a href="orders"><img src="/static/icons/orders.png" alt=""> Orders</a></li>
            <li><a href="payments"><img src="/static/icons/payments.png" alt=""> Payments</a></li>
            {% endif %}


            {% if is_approver(user.mail or user.userPrincipalName) %}
            <div class="line"><span>Approvals</span></div>
            <li><a href="/approvals"><img src="/static/icons/approval.png" alt=""> View Approvals</a></li>
            {% endif %}


            {% if excel_role == "pre-sales" %}
            <div class="line"><span>Pre-sales</span></div>
            <li><a href="/quote"><img src="/static/icons/quote.png" alt="">New Quote</a></li>
            <li><a href="/quote_decision"><img src="/static/icons/quotes.png" alt="">View Quotes</a></li>
            {% endif %}


            <div class="line"><span>Partnership</span></div>
            <li><a href="/vendors"><img src="/static/icons/partnership.png" alt="">Vendors</a></li>
            <li><a href="customers"><img src="/static/icons/customer.png" alt=""> Customer</a></li>
            <li><a href="businesscard"><img src="/static/icons/businesscard.png" alt=""> Business Cards</a></li>


            <div class="line"><span>Reports</span></div>
            <li aria-disabled="false"><a href="reports"><img src="/static/icons/reports.png" alt=""> Reports</a></li>


            <div class="line"><span>Chatbot</span></div>
            <li><a href="chatbot"><img src="/static/icons/chatbot.png" alt=""> Chatbot</a></li>
            <div class="line"><span>Version</span></div>
            <p style="color: #9e9e9e70;">V 7.1.1 s-phto-rm</p>

        </ul>

    </div>
</div>


<style>
    .profile-card {
        position: absolute;
        top: 60px;
        right: 10px;
        width: 230px;
        background: rgba(255, 255, 255, 0.019);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.055);
        z-index: 9999;
    }

    .hidden {
        display: none;
    }

    .profile-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
    }

    .profile-thumb {
        width: 45px;
        height: 45px;
        border-radius: 50%;
    }

    .profile-card-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .profile-card-header p {
        margin: 0;
        font-size: 13px;
        color: #dcdcdc;
    }

    .profile-card-body {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
    }

    .card-link {
        color: #000000;
        text-decoration: none;
        margin: 5px 0;
        transition: color 0.3s;
    }

    .card-link:hover {
        color: #90e0ef;
    }

    .logout {
        color: #ff6b6ba2;
    }
</style>

<script>
    const profilePic = document.querySelector('.profile-pic');
    const profileCard = document.getElementById('profile-card');

    profilePic.addEventListener('click', () => {
        profileCard.classList.toggle('hidden');
    });

    // Hide when clicking outside
    window.addEventListener('click', (e) => {
        if (!profilePic.contains(e.target) && !profileCard.contains(e.target)) {
            profileCard.classList.add('hidden');
        }
    });
</script>