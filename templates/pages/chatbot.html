{% extends "base.html" %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

<div class="flex justify-center mt-8">
    <div class="flex flex-col w-full max-w-4xl h-[700px]">

        <!-- Chat Box -->
        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-3 rounded-lg"></div>

        <!-- Input Box -->
        <div class="flex items-center p-3 border-t">
            <textarea id="messageInput" rows="1"
                class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                placeholder="Type a message..."></textarea>
            <button id="sendBtn"
                class="ml-3 px-5 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Send</button>
        </div>
    </div>
</div>

<script>
const chatBox = document.getElementById("chatBox");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Append message with animation + typing effect for assistant
function appendMessage(message, sender, typing = false) {
    const wrapper = document.createElement("div");
    wrapper.classList.add("w-full", "flex", "fade-in");

    const div = document.createElement("div");
    div.classList.add(
        "p-3", "rounded-xl", "inline-block", "max-w-[70%]",
        "break-words", "bubble-anim"
    );

    if (sender === "user") {
        div.classList.add("bg-blue-500", "text-white", "ml-auto");
        wrapper.classList.add("justify-end");
        div.innerHTML = marked.parse(message);
    } 
    else if (sender === "assistant") {
        div.classList.add("bg-gray-200", "text-gray-900", "mr-auto");
        wrapper.classList.add("justify-start");

        // Typing animation
        if (typing) {
            let index = 0;
            const interval = setInterval(() => {
                div.innerHTML = marked.parse(message.slice(0, index++));
                scrollToBottom();
                if (index > message.length) clearInterval(interval);
            }, 20);
        } else {
            div.innerHTML = marked.parse(message);
        }
    }

    wrapper.appendChild(div);
    chatBox.appendChild(wrapper);
    scrollToBottom();
}

// FIRST BOT MESSAGE (GREETING)
window.onload = function() {
    appendMessage(
        "**Hello! ðŸ‘‹ I'm your AI Task Assistant.**\n\nI can:\n- Show your tasks and due dates\n- Give updates from SharePoint\n- Help you with team analytics\n\nAsk me anything!",
        "assistant",
        true
    );
};

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    appendMessage(message, "user");
    messageInput.value = "";
    messageInput.disabled = true;
    sendBtn.disabled = true;

    // Loading bubble
    const loading = appendLoadingBubble();

    try {
        const res = await fetch("/chatbot/ask", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ message })
        });

        const data = await res.json();

        loading.remove();

        if (data.reply) {
            appendMessage(data.reply, "assistant", true);
        } else {
            appendMessage("Error: " + data.error, "assistant");
        }
    } catch (err) {
        loading.remove();
        appendMessage("Error connecting to server.", "assistant");
        console.error(err);
    } finally {
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.focus();
    }
}

function appendLoadingBubble() {
    const wrapper = document.createElement("div");
    wrapper.classList.add("w-full", "flex", "justify-start", "fade-in");

    const div = document.createElement("div");
    div.classList.add("p-3", "rounded-xl", "inline-block", "bg-gray-200", "mr-auto");
    div.innerHTML = `<span class="typing-dots"><span></span><span></span><span></span></span>`;

    wrapper.appendChild(div);
    chatBox.appendChild(wrapper);
    scrollToBottom();

    return wrapper;
}

// Enter to send, Shift+Enter for new line
messageInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

sendBtn.addEventListener("click", sendMessage);
</script>

<style>
/* Bubble pop animation */
.bubble-anim {
    animation: popIn 0.1s ease-out;
}
@keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

/* Typing dots like WhatsApp */
.typing-dots span {
    height: 8px;
    width: 8px;
    margin: 0 2px;
    background: gray;
    border-radius: 50%;
    display: inline-block;
    animation: blink 1.4s infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.1s; }
.typing-dots span:nth-child(3) { animation-delay: 0.3s; }

@keyframes blink {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
}
</style>
{% endblock %}
