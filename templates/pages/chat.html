
<!DOCTYPE html>
<html>
<head>
    <title>Teams Chat</title>
    <style>
        body { margin:0; padding:0; display:flex; font-family: Arial; height:100vh; }
        #user-list { width:250px; border-right:1px solid #ccc; overflow-y:auto; }
        #user-list ul { list-style:none; padding:0; margin:0; }
        #user-list li { padding:10px; cursor:pointer; border-bottom:1px solid #eee; }
        #user-list li:hover { background:#f0f0f0; }
        #user-list li.active { background:#0078D4; color:white; }

        #chat-panel { flex:1; display:flex; flex-direction:column; }
        #messages { flex:1; padding:10px; overflow-y:auto; border-bottom:1px solid #ccc; }
        #input-area { display:flex; }
        #input-area input { flex:1; padding:10px; border:none; border-top:1px solid #ccc; }
        #input-area button { padding:10px; border:none; background:#0078D4; color:white; cursor:pointer; }
        #input-area button:hover { background:#005a9e; }

        .message { margin-bottom:10px; }
        .message.me { text-align:right; }
        .message .sender { font-weight:bold; margin-right:5px; }
    </style>
</head>
<body>

<div id="user-list">
    <ul>
        {% for u in users_list %}
            <li data-user-id="{{ u.id }}">{{ u.displayName }}<br><small>{{ u.mail }}</small></li>
        {% endfor %}
    </ul>
</div>

<div id="chat-panel">
    <div id="messages">Select a user to start chat...</div>
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="Type a message..." disabled>
        <button id="send-btn" disabled>Send</button>
    </div>
</div>

<script>
let selectedUserId = null;
const messagesDiv = document.getElementById("messages");
const inputBox = document.getElementById("msg-input");
const sendBtn = document.getElementById("send-btn");

document.querySelectorAll("#user-list li").forEach(li => {
    li.addEventListener("click", () => {
        document.querySelectorAll("#user-list li").forEach(x => x.classList.remove("active"));
        li.classList.add("active");

        selectedUserId = li.dataset.userId;
        messagesDiv.innerHTML = "Loading chat...";
        inputBox.disabled = false;
        sendBtn.disabled = false;

        loadChat(selectedUserId);
    });
});

function loadChat(userId) {
    fetch(`/chat/messages/${userId}`)
        .then(res => res.json())
        .then(data => {
            messagesDiv.innerHTML = "";
            data.forEach(msg => {
                const div = document.createElement("div");
                div.classList.add("message");
                if(msg.senderId === "{{ user.id }}") div.classList.add("me");
                div.innerHTML = `<span class="sender">${msg.senderName}:</span> ${msg.body}`;
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
}

sendBtn.addEventListener("click", () => {
    const text = inputBox.value.trim();
    if(!text || !selectedUserId) return;

    fetch(`/chat/send_message/${selectedUserId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    }).then(res => res.json())
      .then(data => {
          inputBox.value = "";
          loadChat(selectedUserId);
      });
});
</script>

</body>
</html>

