{% extends "base.html" %}

{% block content %}

<div class="container my-4">
    <h2 class="mb-4">New Quote</h2>
    <form id="quoteForm" method="POST" action="/send_quote_for_approval">

        <!-- Customer Selection -->
        <div class="mb-3">
            <label for="customerSelect" class="form-label">Select Customer</label>
            <select class="form-select" id="customerSelect" name="customer_id" required>
                {% for cust in customers %}
                <option value="{{ cust.contact_id }}" data-currency="{{ cust.currency_code }}"
                    data-payment="{{ cust.payment_terms }}" data-email="{{ cust.email }}" data-phone="{{ cust.phone }}"
                    data-mobile="{{ cust.mobile }}" data-tax="{{ cust.tax_treatment }}">
                    {{ cust.customer_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Auto-filled Customer Details -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <label class="form-label">Currency</label>
                <input type="text" class="form-control" id="currency" name="currency" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Payment Terms</label>
                <input type="text" class="form-control" id="payment_terms" name="payment_terms" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tax Treatment</label>
                <input type="text" class="form-control" id="tax_treatment" name="tax_treatment" readonly>
            </div>
        </div>

        <!-- Quote Details -->
        <div class="card mb-4 p-3">
            <h5>Quote Details</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Reference #</label>
                    <input type="text" class="form-control" name="reference" placeholder="Reference #" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quote Date</label>
                    <input type="date" class="form-control" name="quote_date" required
                        value="{{ current_date.strftime('%Y-%m-%d') }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Expiry Date</label>
                    <input type="date" class="form-control" name="expiry_date" required>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label class="form-label">Portal</label>
                    <input type="text" class="form-control" name="portal" placeholder="Portal" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">BCD</label>
                    <input type="date" class="form-control" name="bcd" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quote Creator</label>
                    <input type="text" class="form-control" name="quote_creator" value="{{ session.user.displayName }}"
                        required>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="card mb-4 p-3">
            <h5>Items</h5>
            <table class="table table-bordered" id="itemsTable">
                <thead class="table-light">
                    <tr>
                        <th>Item Details</th>
                        <th>Brand</th>
                        <th>Qty</th>
                        <th>Rate (<span id="currencyLabel">AED</span>)</th>
                        <th>Margin (%)</th>
                        <th>Discount (<span id="currencyLabelDiscount">AED</span>)</th>
                        <th>Amount (<span id="currencyLabelAmount">AED</span>)</th>
                        <th>Tax (%)</th>
                        <th>Selling Price (<span id="currencyLabelSelling">AED</span>)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" class="form-control" name="item_details[]" required></td>
                        <td><input type="text" class="form-control" name="brand[]" required></td>
                        <td><input type="number" class="form-control quantity" name="quantity[]" value="1" required></td>
                        <td><input type="number" class="form-control rate" name="rate[]" value="0" required></td>
                        <td><input type="number" class="form-control margin" name="margin[]" value="0" required></td>
                        <td><input type="number" class="form-control discount" name="discount[]" value="0" required></td>
                        <td><input type="number" class="form-control amount" name="amount[]" value="0" readonly></td>
                        <td>
                            <select class="form-select tax" name="tax[]">
                                <option value="0">Out of Scope</option>
                                <option value="0.05">Standard Rate [5%]</option>
                                <option value="0">Zero Rate [0%]</option>
                            </select>
                        </td>
                        <td><input type="number" class="form-control selling_price" name="selling_price[]" value="0" readonly></td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-row"><img src="/static/icons/delete.png" alt=""></button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2">Totals / Avg</th>
                        <th id="totalQuantity">0</th>
                        <th id="Rate">0</th>
                        <th id="avgMargin">0</th>
                        <th id="totalDiscount">0</th>
                        <th id="totalAmount">0</th>
                        <th id="avgTax">0</th>
                        <th id="totalSellingPrice">0</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
            <button type="button" class="btn btn-success" id="addItemBtn">Add Item</button>
        </div>

        <!-- Customer Notes & Terms -->
        <div class="card mb-4 p-3">
            <h5>Customer Notes</h5>
            <textarea name="customer_notes" rows="3" class="form-control mb-3" required></textarea>

            <h5>Terms & Conditions</h5>
            <textarea name="terms_conditions" rows="3" class="form-control" required></textarea>
        </div>

        <!-- Price Summary -->
        <div class="card mb-4 p-3">
            <h5>Price Summary</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Subtotal (<span id="currencyLabelSummary">AED</span>)</label>
                    <input type="number" class="form-control" name="subtotal" id="subtotal" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Total Discount (<span id="currencyLabelSummaryDiscount">AED</span>)</label>
                    <input type="number" class="form-control" name="total_discount" id="total_discount" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Grand Total (<span id="currencyLabelSummarySelling">AED</span>)</label>
                    <input type="number" class="form-control" name="grand_total" id="grand_total" readonly>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-md">Submit Quote for Approval</button>
    </form>
</div>

<script>
    const customerSelect = document.getElementById('customerSelect');
    const currencyInput = document.getElementById('currency');
    const currencyLabels = document.querySelectorAll('#currencyLabel, #currencyLabelAmount, #currencyLabelDiscount, #currencyLabelSelling, #currencyLabelSummary, #currencyLabelSummaryDiscount, #currencyLabelSummarySelling');

    customerSelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        const customerCurrency = selectedOption.getAttribute('data-currency');

        currencyInput.value = customerCurrency;
        currencyLabels.forEach(label => label.innerText = customerCurrency);

        document.getElementById('payment_terms').value = selectedOption.getAttribute('data-payment');
        document.getElementById('email').value = selectedOption.getAttribute('data-email');
        document.getElementById('tax_treatment').value = selectedOption.getAttribute('data-tax');
    });
    customerSelect.dispatchEvent(new Event('change'));

    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];

    function updateCalculations() {
        let totalQty = 0, totalDiscount = 0, totalAmount = 0, totalSelling = 0;
        let totalRate = 0, totalMargin = 0, totalTax = 0, count = 0;

        Array.from(itemsTableBody.rows).forEach(row => {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const margin = parseFloat(row.querySelector('.margin').value) || 0;
            const discount = parseFloat(row.querySelector('.discount').value) || 0;
            const tax = parseFloat(row.querySelector('.tax').value) || 0;

            // Amount after discount
            const amount = (qty * rate * (1 + margin / 100)) - discount;

            // Selling price = amount + tax on amount
            const selling = amount * (1 + tax);

            row.querySelector('.amount').value = amount.toFixed(2);
            row.querySelector('.selling_price').value = selling.toFixed(2);

            totalQty += qty;
            totalDiscount += discount;
            totalAmount += amount;
            totalSelling += selling;
            totalRate += rate;
            totalMargin += margin;
            totalTax += tax;
            count++;
        });

        document.getElementById('totalQuantity').innerText = totalQty.toFixed(2);
        document.getElementById('Rate').innerText = totalRate.toFixed(2);
        document.getElementById('avgMargin').innerText = (totalMargin / count).toFixed(2);
        document.getElementById('totalDiscount').innerText = totalDiscount.toFixed(2);
        document.getElementById('totalAmount').innerText = totalAmount.toFixed(2);
        document.getElementById('avgTax').innerText = (totalTax / count * 100).toFixed(2); // show as %
        document.getElementById('totalSellingPrice').innerText = totalSelling.toFixed(2);

        document.getElementById('subtotal').value = totalAmount.toFixed(2);
        document.getElementById('total_discount').value = totalDiscount.toFixed(2);
        document.getElementById('grand_total').value = totalSelling.toFixed(2);
    }

    addItemBtn.addEventListener('click', function () {
        const newRow = itemsTableBody.rows[0].cloneNode(true);
        Array.from(newRow.querySelectorAll('input')).forEach(input => input.value = input.classList.contains('quantity') ? 1 : 0);
        itemsTableBody.appendChild(newRow);
        updateCalculations();
    });

    itemsTableBody.addEventListener('input', updateCalculations);
    itemsTableBody.addEventListener('change', updateCalculations);

    itemsTableBody.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row') || e.target.closest('.remove-row')) {
            const row = e.target.closest('tr');
            if (itemsTableBody.rows.length > 1) {
                row.remove();
                updateCalculations();
            }
        }
    });

    // initial calculation
    updateCalculations();
</script>

{% endblock %}
