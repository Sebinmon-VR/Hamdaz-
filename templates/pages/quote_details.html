{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Quote Details: {{ quote.Title }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div><strong>Customer :</strong> {{ quote.CustomerName }}</div>
        <div><strong>Currency:</strong> {{ quote.Currency }}</div>
        <div><strong>Payment Terms:</strong> {{ quote.PaymentTerms }}</div>
        <div><strong>Reference:</strong> {{ quote.Reference }}</div>
        <div><strong>Quote Date:</strong> {{ quote.QuoteDate[:10] }}</div>
        <div><strong>Expiry Date:</strong> {{ quote.ExpiryDate[:10] }}</div>
        <div><strong>Portal:</strong> {{ quote.Portal }}</div>
        <div><strong>Quote Creator:</strong> {{ quote.QuoteCreator }}</div>

        <div>
            <strong>Approval Status:</strong>
            <span class="px-2 py-1 rounded"
                style="background-color: {% if quote.ApprovalStatus == 'Approved' %}#d1fae5{% elif quote.ApprovalStatus == 'Rejected' %}#fee2e2{% else %}#fef3c7{% endif %};">
                {{ quote.ApprovalStatus }}
            </span>
        </div>
        <div><strong>Decision By :</strong> {{ quote.ApprovedBy }}</div>
    </div>
    <div class="mt-4">
        <strong class="flex items-center gap-2">
            <img src="/static/icons/files.png" alt="Files" class="w-5 h-5"> Attachments:
        </strong>

        <div class="flex flex-col gap-2 mt-2">
            {% for link in quote.AttachmentLinks %}
            {% set filename = link.split('/')[-1] %}
            <a href="{{ link }}" target="_blank"
                class="flex items-center gap-2 p-2 bg-gray-100 rounded hover:bg-gray-200 transition cursor-pointer w-max">
                <img src="/static/icons/file-icon.png" alt="File" class="w-6 h-6">
                <span class="truncate max-w-xs">{{ filename }}</span>
            </a>
            {% else %}
            <span class="text-gray-500">No attachments available.</span>
            {% endfor %}
        </div>
    </div>
    <h2 class="text-xl font-semibold mb-2 mt-3">Items</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow rounded-lg">
            <thead>
                <tr class="bg-gray-100 text-left">
                    <th class="px-4 py-2">Item Details</th>
                    <th class="px-4 py-2">Brand</th>
                    <th class="px-4 py-2">Quantity</th>
                    <th class="px-4 py-2">Rate ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Margin (%)</th>
                    <th class="px-4 py-2">Discount ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Amount (after Discount) ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Tax (%)</th>
                    <th class="px-4 py-2">Tax Amount ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Selling Price ({{ quote.Currency }})</th>
                </tr>
            </thead>
            <tbody>
                {% for item in quote.AllItems_parsed %}
                {% set qty = item.Quantity | default(0) %}
                {% set rate = item.Rate | default(0) %}
                {% set margin = item.Margin | default(0) %}
                {% set discount = item.get('Discount', 0) | default(0) %}
                {% set tax = item.Tax | default(0) %}
                {% set base_amount = (qty * rate * (1 + margin / 100)) %}
                {% set amount = (base_amount - discount) | round(2) %}
                {% set tax_amount = (amount * tax) | round(2) %}
                {% set selling = (amount + tax_amount) | round(2) %}
                <tr class="hover:bg-gray-50">
                    <td class="border px-4 py-2">{{ item.ItemDetails }}</td>
                    <td class="border px-4 py-2">{{ item.Brand }}</td>
                    <td class="border px-4 py-2">{{ qty }}</td>
                    <td class="border px-4 py-2">{{ rate | round(2) }}</td>
                    <td class="border px-4 py-2">{{ margin | round(2) }}%</td>
                    <td class="border px-4 py-2">{{ discount | round(2) }}</td>
                    <td class="border px-4 py-2">{{ amount }}</td>
                    <td class="border px-4 py-2">{{ (tax*100) | round(2) }}%</td>
                    <td class="border px-4 py-2">{{ tax_amount }}</td>
                    <td class="border px-4 py-2">{{ selling }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="10" class="text-center py-4">No items found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 class="text-xl font-semibold mt-6 mb-2">Pricing Summary</h2>
        <table class="min-w-full bg-white shadow rounded-lg mb-6">
            <thead>
                <tr class="bg-gray-100 text-left">
                    <th class="px-4 py-2">Total Rate ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Average Margin (%)</th>
                    <th class="px-4 py-2">Total Discount ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Total Tax ({{ quote.Currency }})</th>
                    <th class="px-4 py-2">Total Selling Price ({{ quote.Currency }})</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="border px-4 py-2">{{ quote.Totals.Rate | default(0) | round(2) }}</td>
                    <td class="border px-4 py-2">{{ quote.Totals.AvgMargin | default(0) | round(2) }}%</td>
                    <td class="border px-4 py-2">{{ quote.Totals.Discount | default(0) | round(2) }}</td>
                    <td class="border px-4 py-2">{{ quote.Totals.Tax }}</td>
                    <td class="border px-4 py-2">{{ quote.Totals.SellingPrice}}</td>
                </tr>
            </tbody>
        </table>

    </div>

    <!-- Attachments Section -->



</div>
{% endblock %}