{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.3.2/tailwind.min.css">
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body { background-color: #ffffff; color: #111111; font-family: 'Segoe UI', sans-serif; }
.drag-drop { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.4s ease; font-size: 1rem; color: #475569; width: 220px; background-color: #f8fafc; }
.drag-drop.dragover { background-color: #e2e8f0; border-color: #94a3b8; }
.reupload-btn, button { background-color: #1f2937; color: #f9fafb; border-radius: 6px; padding: 8px 12px; cursor: pointer; transition: all 0.4s ease; }
.reupload-btn:hover, button:hover { background-color: #374151; }
.tab-button { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
.tab-button.active { border-color: #111827; font-weight: 600; color: #111827; }
.vscode-panel { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; overflow-y: auto; }
.scroll-container { max-height: 60vh; overflow-y: auto; }
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #1f2937; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin-left: 8px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.tree-node { margin-left: 16px; line-height: 1.5rem; }
.tree-key { font-weight: 600; cursor: pointer; color: #111827; }
.tree-key:hover { text-decoration: underline; }
.tree-value { margin-left: 12px; color: #475569; word-break: break-word; }
.download-btn { background-color: #10b981; color: white; padding: 6px 12px; border-radius: 6px; margin-top: 4px; cursor: pointer; transition: all 0.3s ease; }
.download-btn:hover { background-color: #059669; }
.draggable-file { padding: 4px 8px; margin-bottom: 4px; background-color: #e2e8f0; border-radius: 4px; cursor: grab; display:flex; justify-content:space-between; align-items:center; }
.draggable-file.dragging { opacity: 0.5; }
.remove-btn { margin-left: 8px; color: red; cursor:pointer; font-weight:bold; }
#custom-attachment-popup input[type="text"] { width: 100%; }
</style>
    <!-- Upload + Buttons -->
    <div class="flex items-center space-x-4 mt-4">
        <div id="pdf-drop" class="drag-drop">Drag & Drop PDF or Click</div>
        <button id="reupload-btn" class="reupload-btn hidden">⟳ Re-upload</button>
        <button id="toggle-preview">Toggle PDF Preview</button>
        <button id="analyze-btn">Analyze PDF</button>
    </div>

    <!-- Status + Loader -->
    <div class="flex justify-center items-center mt-2">
        <span id="analyze-status" class="text-gray-600 mr-2"></span>
        <div id="analyze-loader" class="loader"></div>
    </div>

    <!-- PDF Preview -->
    <div id="pdf-preview-container" class="vscode-panel hidden mt-4">
        <iframe id="pdf-preview" class="w-full h-96 border rounded"></iframe>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-4 mt-6 border-b">
        <div id="tab-extracted" class="tab-button active">Extracted Data</div>
        <div id="tab-attachments" class="tab-button">Attachments</div>
        <div id="tab-tech" class="tab-button">Technical Proposal</div>
        <div id="tab-commercial" class="tab-button">Commercial Proposal</div>
    </div>

    <!-- Tab Content -->
    <div class="flex flex-col mt-4 space-y-4">

        <!-- Extracted Data -->
        <div id="content-extracted" class="tab-content vscode-panel scroll-container">
            <div id="extracted-data" class="space-y-2"></div>
        </div>

        <!-- Attachments Table -->
        <div id="content-attachments" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex justify-end mb-2">
                <button id="add-custom-attachment" class="reupload-btn">+ Add Custom Attachment</button>
            </div>

            <!-- Custom attachment popup -->
            <div id="custom-attachment-popup" class="vscode-panel p-4 mb-4 hidden border border-gray-300 rounded">
                <div class="flex flex-col space-y-2">
                    <input type="text" id="custom-attachment-name" placeholder="Attachment Name" class="p-2 border rounded">
                    <input type="file" id="custom-attachment-file" class="p-2 border rounded">
                    <div class="flex space-x-2">
                        <button id="custom-attachment-add" class="reupload-btn">Add</button>
                        <button id="custom-attachment-cancel" class="reupload-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <table class="w-full text-left border border-gray-300 rounded">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border-b">Attachment</th>
                        <th class="p-2 border-b">Upload File</th>
                        <th class="p-2 border-b text-center">Technical Proposal (TP)</th>
                        <th class="p-2 border-b text-center">Commercial Proposal (CP)</th>
                    </tr>
                </thead>
                <tbody id="attachments-table-body"></tbody>
            </table>
        </div>

        <!-- Technical Proposal -->
        <div id="content-tech" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex space-x-4">
                <div id="tp-selected-files" class="w-1/2 vscode-panel scroll-container">
                    <h3 class="font-semibold mb-2">Selected Files (Drag to Reorder)</h3>
                </div>
                <div id="tp-merged-preview" class="w-1/2 vscode-panel">
                    <h3 class="font-semibold mb-2">Merged PDF</h3>
                    <iframe id="tp-merged-iframe" class="w-full h-96 border rounded"></iframe>
                    <button id="tp-download" class="download-btn">Download TP</button>
                </div>
            </div>
        </div>

        <!-- Commercial Proposal -->
        <div id="content-commercial" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex space-x-4">
                <div id="cp-selected-files" class="w-1/2 vscode-panel scroll-container">
                    <h3 class="font-semibold mb-2">Selected Files (Drag to Reorder)</h3>
                </div>
                <div id="cp-merged-preview" class="w-1/2 vscode-panel">
                    <h3 class="font-semibold mb-2">Merged PDF</h3>
                    <iframe id="cp-merged-iframe" class="w-full h-96 border rounded"></iframe>
                    <button id="cp-download" class="download-btn">Download CP</button>
                    
                </div>
            </div>
        </div>

    </div>

</div>

<input type="file" id="pdf-upload" accept="application/pdf" class="hidden" />

<script>
let uploadedFile = null;
const pdfDrop = document.getElementById('pdf-drop');
const pdfUpload = document.getElementById('pdf-upload');
const reuploadBtn = document.getElementById('reupload-btn');
const pdfPreview = document.getElementById('pdf-preview');
const pdfPreviewContainer = document.getElementById('pdf-preview-container');

pdfDrop.addEventListener('click', () => pdfUpload.click());
pdfDrop.addEventListener('dragover', e => { e.preventDefault(); pdfDrop.classList.add('dragover'); });
pdfDrop.addEventListener('dragleave', e => pdfDrop.classList.remove('dragover'));
pdfDrop.addEventListener('drop', e => { e.preventDefault(); pdfDrop.classList.remove('dragover'); handlePDF(e.dataTransfer.files[0]); });

reuploadBtn.addEventListener('click', () => { pdfDrop.style.display = 'block'; pdfDrop.style.opacity = '1'; reuploadBtn.classList.add('hidden'); pdfUpload.click(); });

pdfUpload.addEventListener('change', e => handlePDF(e.target.files[0]));

function handlePDF(file){
    if(!file) return;
    uploadedFile = file;
    pdfPreview.src = URL.createObjectURL(file);
    pdfPreviewContainer.classList.remove('hidden');
    pdfDrop.style.transition = "all 0.4s ease";
    pdfDrop.style.opacity = "0";
    setTimeout(()=>{ pdfDrop.style.display="none"; reuploadBtn.classList.remove('hidden'); },400);
}

document.getElementById('toggle-preview').addEventListener('click', () => {
    if(!uploadedFile){ alert("Please upload a PDF first!"); return; }
    pdfPreviewContainer.classList.toggle('hidden');
});

// --- Tabs ---
const tabMap = { 'tab-extracted':'content-extracted', 'tab-attachments':'content-attachments', 'tab-tech':'content-tech', 'tab-commercial':'content-commercial' };
Object.keys(tabMap).forEach(tabId => {
    document.getElementById(tabId).addEventListener('click', () => {
        Object.keys(tabMap).forEach(id => {
            document.getElementById(id).classList.remove('active');
            document.getElementById(tabMap[id]).classList.add('hidden');
        });
        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabMap[tabId]).classList.remove('hidden');
    });
});

// --- Analyze PDF ---
const analyzeBtn = document.getElementById('analyze-btn');
const analyzeLoader = document.getElementById('analyze-loader');
const analyzeStatus = document.getElementById('analyze-status');
const extractedDataContainer = document.getElementById('extracted-data');
let attachmentsFiles = {};
let mergedTPBlob = null, mergedCPBlob = null;

analyzeBtn.addEventListener('click', async ()=> {
    if(!uploadedFile){ alert("Please upload a PDF first!"); return; }
    extractedDataContainer.innerHTML = '';
    analyzeLoader.style.display = 'inline-block';
    analyzeStatus.textContent = "Analyzing PDF...";
    const formData = new FormData();
    formData.append('pdf_file', uploadedFile);

    try{
        const res = await fetch('/analyze',{method:'POST', body:formData});
        const data = await res.json();
        analyzeLoader.style.display = 'none';
        analyzeStatus.textContent="";
        if(data.error){ extractedDataContainer.innerHTML = `<div class='text-red-600'>Error: ${data.error}</div>`; return; }
        let aiOutput = data.extracted_data.raw_text || data.extracted_data;
        if(typeof aiOutput==='string'){ aiOutput = aiOutput.replace(/^```json\s*|```$/g,''); try{ aiOutput = JSON.parse(aiOutput); } catch(e){ extractedDataContainer.innerHTML="<div class='text-red-600'>Could not parse AI output.</div>"; return; } }
        renderTree(aiOutput);
        renderAttachmentTable(aiOutput);
    } catch(err){ extractedDataContainer.innerHTML=`<div class='text-red-600'>Error: ${err.message}</div>`; analyzeLoader.style.display = 'none'; analyzeStatus.textContent=""; }
});

// --- Tree Renderer ---
function renderTree(data, parent = extractedDataContainer){
    function createNode(key, value){
        const node = document.createElement('div'); node.className = 'tree-node';
        const keyEl = document.createElement('div'); keyEl.className = 'tree-key'; keyEl.textContent = key; node.appendChild(keyEl);
        if(value !== null && typeof value === 'object'){
            const childrenContainer = document.createElement('div'); childrenContainer.style.marginLeft = '12px'; childrenContainer.style.display = 'block';
            if(Array.isArray(value)){ value.forEach((item,idx)=> childrenContainer.appendChild(createNode(idx+1,item))); } else { Object.entries(value).forEach(([k,v])=> childrenContainer.appendChild(createNode(k,v))); }
            keyEl.addEventListener('click', ()=> { childrenContainer.style.display = childrenContainer.style.display === 'none' ? 'block' : 'block'; });
            node.appendChild(childrenContainer);
        } else { const valEl = document.createElement('div'); valEl.className = 'tree-value'; valEl.textContent = value; node.appendChild(valEl); }
        return node;
    }
    Object.entries(data).forEach(([k,v]) => parent.appendChild(createNode(k,v)));
}

// --- Attachments Table ---
function renderAttachmentTable(data){
    const tableBody = document.getElementById('attachments-table-body');
    
    // Remove only previously rendered extracted attachments
    const existingExtracted = tableBody.querySelectorAll('.extracted-attachment-row');
    existingExtracted.forEach(r => tableBody.removeChild(r));

    const attachmentsNeeded = data.attachments_needed || (data.requirements && data.requirements.attachments_needed);
    if(!attachmentsNeeded || attachmentsNeeded.length===0){ 
        // Optional: only show message if table empty
        if(tableBody.children.length === 0){
            tableBody.innerHTML = `<tr><td colspan="4" class="text-gray-500 p-2">No attachments required.</td></tr>`;
        }
        return; 
    }

    attachmentsNeeded.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.classList.add('extracted-attachment-row'); // mark it as extracted row
        const tdName = document.createElement('td'); tdName.className = "p-2 border-b"; tdName.textContent = item;
        const tdFile = document.createElement('td'); tdFile.className = "p-2 border-b"; 
        const input = document.createElement('input'); input.type='file'; 
        input.addEventListener('change', e=>{
            attachmentsFiles[item]=attachmentsFiles[item]||{};
            attachmentsFiles[item].file=e.target.files[0];
            updateProposals();
        });
        tdFile.appendChild(input);
        const tdTP = document.createElement('td'); tdTP.className="p-2 border-b text-center"; const tpCheck=document.createElement('input'); tpCheck.type='checkbox'; tpCheck.addEventListener('change',updateProposals); tdTP.appendChild(tpCheck);
        const tdCP = document.createElement('td'); tdCP.className="p-2 border-b text-center"; const cpCheck=document.createElement('input'); cpCheck.type='checkbox'; cpCheck.addEventListener('change',updateProposals); tdCP.appendChild(cpCheck);
        tr.appendChild(tdName); tr.appendChild(tdFile); tr.appendChild(tdTP); tr.appendChild(tdCP);
        tableBody.appendChild(tr);

        attachmentsFiles[item] = attachmentsFiles[item] || { file:null, tp:tpCheck, cp:cpCheck };
    });
}
// --- Prefill Attachments Table from Top Files with Download & Convert ---
document.addEventListener('DOMContentLoaded', ()=>{
    const tableBody = document.getElementById('attachments-table-body');
    
    {% for f in files %}
        const tr = document.createElement('tr');
        tr.className = 'default-attachment-row';

        const tdName = document.createElement('td'); tdName.className="p-2 border-b"; tdName.textContent="{{ f.name }}";
        tr.appendChild(tdName);

        const tdFile = document.createElement('td'); tdFile.className="p-2 border-b text-center";
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = "Download & Convert";
        downloadBtn.className = "download-btn";
        downloadBtn.dataset.fileId = "{{ f.id }}";
        downloadBtn.dataset.fileName = "{{ f.name }}";
        tdFile.appendChild(downloadBtn);
        tr.appendChild(tdFile);

        const tdTP = document.createElement('td'); tdTP.className="p-2 border-b text-center";
        const tpCheck=document.createElement('input'); tpCheck.type='checkbox'; tpCheck.addEventListener('change', updateProposals);
        tdTP.appendChild(tpCheck); tr.appendChild(tdTP);

        const tdCP = document.createElement('td'); tdCP.className="p-2 border-b text-center";
        const cpCheck=document.createElement('input'); cpCheck.type='checkbox'; cpCheck.addEventListener('change', updateProposals);
        tdCP.appendChild(cpCheck); tr.appendChild(tdCP);

        tableBody.appendChild(tr);

        attachmentsFiles["{{ f.name }}"]={ file:null, tp:tpCheck, cp:cpCheck };

        // --- Download & Convert handler ---
        downloadBtn.addEventListener('click', async ()=>{
            downloadBtn.disabled = true; downloadBtn.textContent="Downloading...";
            try {
                const res = await fetch(`/download/pdf/${downloadBtn.dataset.fileId}`);
                if(!res.ok) throw new Error("Download failed");
                const blob = await res.blob();
                const pdfFile = new File([blob], downloadBtn.dataset.fileName.replace(/\.[^/.]+$/, ".pdf"), {type:'application/pdf'});
                attachmentsFiles[downloadBtn.dataset.fileName].file = pdfFile;
                downloadBtn.textContent="file added ✅";
                updateProposals();
            } catch(err){
                console.error(err);
                alert("Failed to download/convert file");
                downloadBtn.textContent="Download & Convert";
            } finally { downloadBtn.disabled=false; }
        });

    {% endfor %}
});

// --- Custom Attachments ---
const addCustomBtn = document.getElementById('add-custom-attachment');
const customPopup = document.getElementById('custom-attachment-popup');
const customNameInput = document.getElementById('custom-attachment-name');
const customFileInput = document.getElementById('custom-attachment-file');
const customAddBtn = document.getElementById('custom-attachment-add');
const customCancelBtn = document.getElementById('custom-attachment-cancel');

addCustomBtn.addEventListener('click', ()=> customPopup.classList.remove('hidden'));
customCancelBtn.addEventListener('click', ()=> { customPopup.classList.add('hidden'); customNameInput.value=''; customFileInput.value=''; });

customAddBtn.addEventListener('click', ()=> {
    const name = customNameInput.value.trim();
    const file = customFileInput.files[0];
    if(!name || !file){ alert("Please provide name and file"); return; }

    const tableBody = document.getElementById('attachments-table-body');
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.className="p-2 border-b"; tdName.textContent=name;
    const tdFile = document.createElement('td'); tdFile.className="p-2 border-b";
    const input = document.createElement('input'); input.type='file'; input.files = customFileInput.files;
    tdFile.appendChild(input);
    const tdTP = document.createElement('td'); tdTP.className="p-2 border-b text-center"; const tpCheck=document.createElement('input'); tpCheck.type='checkbox'; tpCheck.addEventListener('change',updateProposals); tdTP.appendChild(tpCheck);
    const tdCP = document.createElement('td'); tdCP.className="p-2 border-b text-center"; const cpCheck=document.createElement('input'); cpCheck.type='checkbox'; cpCheck.addEventListener('change',updateProposals); tdCP.appendChild(cpCheck);
    tr.appendChild(tdName); tr.appendChild(tdFile); tr.appendChild(tdTP); tr.appendChild(tdCP);
    tableBody.appendChild(tr);

    attachmentsFiles[name] = { file:file, tp:tpCheck, cp:cpCheck };
    customPopup.classList.add('hidden'); customNameInput.value=''; customFileInput.value='';
    updateProposals();
});

// --- Drag & Drop, Remove, Merge, Download ---
function enableDragAndSort(containerId) {
    const container = document.getElementById(containerId);

    container.addEventListener("dragstart", (e) => {
        if (e.target.classList.contains("draggable-file")) {
            e.target.classList.add("dragging");
        }
    });

    container.addEventListener("dragend", (e) => {
        if (e.target.classList.contains("draggable-file")) {
            e.target.classList.remove("dragging");
            updateProposals(); // re-generate merged PDFs
        }
    });

    container.addEventListener("dragover", (e) => {
        e.preventDefault();
        const dragging = container.querySelector(".dragging");
        if (!dragging) return;

        const after = getDragAfterElement(container, e.clientY);
        if (after == null) {
            container.appendChild(dragging);
        } else {
            container.insertBefore(dragging, after);
        }
    });

    function getDragAfterElement(container, y) {
        const elements = [...container.querySelectorAll(".draggable-file:not(.dragging)")];

        return elements.reduce(
            (closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - (box.top + box.height / 2);

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                }
                return closest;
            },
            { offset: Number.NEGATIVE_INFINITY, element: null }
        ).element;
    }
}


function makeRemovable(containerId){
    const container = document.getElementById(containerId);
    container.addEventListener('click', e=>{
        if(e.target.classList.contains('remove-btn')){
            const attName = e.target.dataset.name;
            container.removeChild(e.target.parentElement);
            if(attachmentsFiles[attName]){
                attachmentsFiles[attName].tp.checked = false;
                attachmentsFiles[attName].cp.checked = false;
            }
            updateProposals();
        }
    });
}
makeRemovable('tp-selected-files');
makeRemovable('cp-selected-files');
function updateProposals(){
    const tpDiv = document.getElementById('tp-selected-files'); 
    const tpIframe = document.getElementById('tp-merged-iframe');
    const cpDiv = document.getElementById('cp-selected-files'); 
    const cpIframe = document.getElementById('cp-merged-iframe');

    // --- Instead of clearing innerHTML, remember existing order ---
    function getCurrentOrder(container){
        return [...container.querySelectorAll('.draggable-file')].map(d => d.dataset.name);
    }

    const tpOrder = getCurrentOrder(tpDiv);
    const cpOrder = getCurrentOrder(cpDiv);

    tpDiv.innerHTML=""; cpDiv.innerHTML="";

    const tpFiles=[]; const cpFiles=[];

    for(const [name,obj] of Object.entries(attachmentsFiles)){
        if(obj.tp.checked && obj.file) tpFiles.push({name:name, file:obj.file});
        if(obj.cp.checked && obj.file) cpFiles.push({name:name, file:obj.file});
    }

    function renderDraggableFiles(files, container, previousOrder=[]){
        // Sort files according to previous drag order if possible
        files.sort((a,b)=>{
            const aIndex = previousOrder.indexOf(a.name);
            const bIndex = previousOrder.indexOf(b.name);
            if(aIndex===-1 && bIndex===-1) return 0;
            if(aIndex===-1) return 1;
            if(bIndex===-1) return -1;
            return aIndex - bIndex;
        });

        files.forEach(f=>{
            const div = document.createElement('div');
            div.className='draggable-file flex justify-between items-center';
            div.setAttribute('draggable','true');
            div.dataset.name=f.name;

            const span = document.createElement('span'); span.textContent=f.name;

            const removeBtn = document.createElement('button'); 
            removeBtn.textContent='✕'; 
            removeBtn.className='remove-btn ml-2 text-red-600 font-bold';
            removeBtn.dataset.name=f.name;

            div.appendChild(span); div.appendChild(removeBtn);
            container.appendChild(div);

            // Bind drag events individually
            div.addEventListener('dragstart', e=> div.classList.add('dragging'));
            div.addEventListener('dragend', e=>{
                div.classList.remove('dragging'); 
                updateProposals(); // regenerate merged PDFs
            });
        });

        // Enable container dragover
        container.addEventListener('dragover', e=>{
            e.preventDefault();
            const dragging = container.querySelector('.dragging');
            if(!dragging) return;

            const elements = [...container.querySelectorAll('.draggable-file:not(.dragging)')];
            const afterElement = elements.reduce((closest, child)=>{
                const box = child.getBoundingClientRect();
                const offset = e.clientY - (box.top + box.height/2);
                if(offset < 0 && offset > closest.offset){
                    return { offset: offset, element: child };
                } return closest;
            }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;

            if(!afterElement) container.appendChild(dragging);
            else container.insertBefore(dragging, afterElement);
        });
    }

    renderDraggableFiles(tpFiles,tpDiv,tpOrder);
    renderDraggableFiles(cpFiles,cpDiv,cpOrder);

    async function mergeFiles(files){
        if(files.length===0) return null;
        const mergedPdf = await PDFLib.PDFDocument.create();
        for(const f of files){
            const bytes = await f.file.arrayBuffer();
            const pdf = await PDFLib.PDFDocument.load(bytes);
            const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
            copiedPages.forEach(p=> mergedPdf.addPage(p));
        }
        const mergedBytes = await mergedPdf.save();
        return new Blob([mergedBytes], {type:'application/pdf'});
    }

    mergedTPBlob = mergeFiles(tpFiles);
    mergedCPBlob = mergeFiles(cpFiles);

    mergedTPBlob.then(blob=> tpIframe.src = URL.createObjectURL(blob));
    mergedCPBlob.then(blob=> cpIframe.src = URL.createObjectURL(blob));
}

// --- Download ---
document.getElementById('tp-download').addEventListener('click', async ()=>{
    if(!mergedTPBlob) return alert("No TP merged file");
    const blob = await mergedTPBlob;
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="Technical_Proposal.pdf"; a.click();
});
document.getElementById('cp-download').addEventListener('click', async ()=>{
    if(!mergedCPBlob) return alert("No CP merged file");
    const blob = await mergedCPBlob;
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="Commercial_Proposal.pdf"; a.click();
});
</script>
{% endblock %}
