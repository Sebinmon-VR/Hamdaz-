{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.3.2/tailwind.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    body { background-color: #ffffff; color: #111111; font-family: 'Segoe UI', sans-serif; }
    .drag-drop { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.4s ease; font-size: 1rem; color: #475569; width: 220px; background-color: #f8fafc; }
    .drag-drop.dragover { background-color: #e2e8f0; border-color: #94a3b8; }
    .reupload-btn, button { background-color: #1f2937; color: #f9fafb; border-radius: 6px; padding: 8px 12px; cursor: pointer; transition: all 0.4s ease; }
    .reupload-btn:hover, button:hover { background-color: #374151; }
    .tab-button { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
    .tab-button.active { border-color: #111827; font-weight: 600; color: #111827; }
    .vscode-panel { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; overflow-y: auto; }
    .scroll-container { max-height: 60vh; overflow-y: auto; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1f2937; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin-left: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tree-node { margin-left: 16px; line-height: 1.5rem; }
    .tree-key { font-weight: 600; cursor: pointer; color: #111827; }
    .tree-key:hover { text-decoration: underline; }
    .tree-value { margin-left: 12px; color: #475569; word-break: break-word; }
    .download-btn { background-color: #10b981; color: white; padding: 6px 12px; border-radius: 6px; margin-top: 4px; cursor: pointer; transition: all 0.3s ease; }
    .download-btn:hover { background-color: #059669; }
    .draggable-file { padding: 4px 8px; margin-bottom: 4px; background-color: #e2e8f0; border-radius: 4px; cursor: grab; display:flex; justify-content:space-between; align-items:center; }
    .draggable-file.dragging { opacity: 0.5; }
    .remove-btn { margin-left: 8px; color: red; cursor:pointer; font-weight:bold; }
    
    /* Editor Specific Styles */
    #editor-container { height: 400px; background: white; }
    .ql-toolbar { background: #f3f4f6; border-radius: 8px 8px 0 0; }
    .ql-container { border-radius: 0 0 8px 8px; }
</style>

    <div class="flex items-center space-x-4 mt-4">
        <div id="pdf-drop" class="drag-drop">Drag & Drop PDF or Click</div>
        <button id="reupload-btn" class="reupload-btn hidden">⟳ Re-upload</button>
        <button id="toggle-preview">Toggle PDF Preview</button>
        <button id="analyze-btn">Analyze PDF</button>
    </div>

    <div class="flex justify-center items-center mt-2">
        <span id="analyze-status" class="text-gray-600 mr-2"></span>
        <div id="analyze-loader" class="loader"></div>
    </div>

    <div id="pdf-preview-container" class="vscode-panel hidden mt-4">
        <iframe id="pdf-preview" class="w-full h-96 border rounded"></iframe>
    </div>

    <div class="flex space-x-4 mt-6 border-b">
        <div id="tab-extracted" class="tab-button active">Extracted Data</div>
        <div id="tab-items-distributors" class="tab-button">Items & Distributors</div> 
        <div id="tab-attachments" class="tab-button">Attachments</div>
        <div id="tab-tech" class="tab-button">Technical Proposal</div>
        <div id="tab-commercial" class="tab-button">Commercial Proposal</div>
    </div>

    <div class="flex flex-col mt-4 space-y-4">

        <div id="content-extracted" class="tab-content vscode-panel scroll-container">
            <div id="extracted-data" class="space-y-2"></div>
        </div>
        
        <div id="content-items-distributors" class="tab-content vscode-panel scroll-container hidden">
            <div id="items-distributors-container"></div>
        </div>

        <div id="content-attachments" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex justify-end mb-2">
                <button id="add-custom-attachment" class="reupload-btn">+ Add Custom Attachment</button>
            </div>

            <div id="custom-attachment-popup" class="vscode-panel p-4 mb-4 hidden border border-gray-300 rounded">
                <div class="flex flex-col space-y-2">
                    <input type="text" id="custom-attachment-name" placeholder="Attachment Name" class="p-2 border rounded">
                    <input type="file" id="custom-attachment-file" class="p-2 border rounded">
                    <div class="flex space-x-2">
                        <button id="custom-attachment-add" class="reupload-btn">Add</button>
                        <button id="custom-attachment-cancel" class="reupload-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <table class="w-full text-left border border-gray-300 rounded">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border-b">Attachment</th>
                        <th class="p-2 border-b">Action</th>
                        <th class="p-2 border-b text-center">TP</th>
                        <th class="p-2 border-b text-center">CP</th>
                    </tr>
                </thead>
                <tbody id="attachments-table-body"></tbody>
            </table>
        </div>

        <div id="content-tech" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex space-x-4">
                <div id="tp-selected-files" class="w-1/2 vscode-panel scroll-container">
                    <h3 class="font-semibold mb-2">Selected Files (Drag to Reorder)</h3>
                </div>
                <div id="tp-merged-preview" class="w-1/2 vscode-panel">
                    <h3 class="font-semibold mb-2">Merged PDF</h3>
                    <iframe id="tp-merged-iframe" class="w-full h-96 border rounded"></iframe>
                    <button id="tp-download" class="download-btn">Download TP</button>
                </div>
            </div>
        </div>

        <div id="content-commercial" class="tab-content vscode-panel scroll-container hidden">
            <div class="flex space-x-4">
                <div id="cp-selected-files" class="w-1/2 vscode-panel scroll-container">
                    <h3 class="font-semibold mb-2">Selected Files (Drag to Reorder)</h3>
                </div>
                <div id="cp-merged-preview" class="w-1/2 vscode-panel">
                    <h3 class="font-semibold mb-2">Merged PDF</h3>
                    <iframe id="cp-merged-iframe" class="w-full h-96 border rounded"></iframe>
                    <button id="cp-download" class="download-btn">Download CP</button>
                </div>
            </div>
        </div>

    </div>

</div>

<div id="editor-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white w-3/4 h-5/6 rounded-lg shadow-lg flex flex-col p-4">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-gray-800">Edit Document</h3>
            <button id="close-editor-btn" class="text-gray-500 hover:text-red-500 font-bold text-xl">&times;</button>
        </div>
        
        <div class="flex-grow bg-white">
            <div id="editor-container"></div>
        </div>

        <div class="flex justify-between items-center mt-4 pt-2 border-t">
            <span id="editor-status" class="text-sm text-red-500 font-semibold italic"></span>
            <div class="space-x-2">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded text-gray-800">Cancel</button>
                <button id="save-convert-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-semibold">Save & Convert to PDF</button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="pdf-upload" accept="application/pdf" class="hidden" />

<script>
let uploadedFile = null;
const pdfDrop = document.getElementById('pdf-drop');
const pdfUpload = document.getElementById('pdf-upload');
const reuploadBtn = document.getElementById('reupload-btn');
const pdfPreview = document.getElementById('pdf-preview');
const pdfPreviewContainer = document.getElementById('pdf-preview-container');

// --- Editor Modal Logic (Quill) ---
const editorModal = document.getElementById('editor-modal');
const closeEditorBtn = document.getElementById('close-editor-btn');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const saveConvertBtn = document.getElementById('save-convert-btn');
const editorStatus = document.getElementById('editor-status');
let currentEditingFileDetails = null; 

var quill = new Quill('#editor-container', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline', 'strike'],        
            ['blockquote', 'code-block'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],          
            [{ 'align': [] }],
            ['clean']                                         
        ]
    }
});

const closeEditor = () => {
    editorModal.classList.add('hidden');
    quill.setText(''); 
    currentEditingFileDetails = null;
    editorStatus.textContent = "";
    saveConvertBtn.disabled = false;
};

closeEditorBtn.addEventListener('click', closeEditor);
cancelEditBtn.addEventListener('click', closeEditor);

saveConvertBtn.addEventListener('click', async () => {
    if (!currentEditingFileDetails) return;
    
    const btn = currentEditingFileDetails.btn;
    const fileName = currentEditingFileDetails.name;
    const editorContent = document.querySelector('#editor-container .ql-editor').innerHTML;
    
    editorStatus.textContent = "Generating PDF... Please wait.";
    editorStatus.classList.remove('text-red-500');
    editorStatus.classList.add('text-blue-500');
    saveConvertBtn.disabled = true;

    const opt = {
        margin:       0.5,
        filename:     fileName.replace(/\.[^/.]+$/, ".pdf"),
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    try {
        const pdfBlob = await html2pdf().set(opt).from(editorContent).output('blob');
        const pdfFile = new File([pdfBlob], fileName.replace(/\.[^/.]+$/, ".pdf"), { type: 'application/pdf' });

        attachmentsFiles[fileName].file = pdfFile;
        
        btn.textContent = "Edited & Ready ✅";
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-800', 'download-btn'); 
        btn.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white', 'p-2', 'rounded');
        
        updateProposals();
        closeEditor();
    } catch (err) {
        console.error(err);
        editorStatus.classList.add('text-red-500');
        editorStatus.textContent = "Error converting to PDF. See console.";
        saveConvertBtn.disabled = false;
    }
});

// --- Standard Handlers ---
pdfDrop.addEventListener('click', () => pdfUpload.click());
pdfDrop.addEventListener('dragover', e => { e.preventDefault(); pdfDrop.classList.add('dragover'); });
pdfDrop.addEventListener('dragleave', e => pdfDrop.classList.remove('dragover'));
pdfDrop.addEventListener('drop', e => { e.preventDefault(); pdfDrop.classList.remove('dragover'); handlePDF(e.dataTransfer.files[0]); });
reuploadBtn.addEventListener('click', () => { pdfDrop.style.display = 'block'; pdfDrop.style.opacity = '1'; reuploadBtn.classList.add('hidden'); pdfUpload.click(); });
pdfUpload.addEventListener('change', e => handlePDF(e.target.files[0]));

function handlePDF(file){
    if(!file) return;
    uploadedFile = file;
    pdfPreview.src = URL.createObjectURL(file);
    pdfPreviewContainer.classList.remove('hidden');
    pdfDrop.style.display="none"; reuploadBtn.classList.remove('hidden');
}

document.getElementById('toggle-preview').addEventListener('click', () => {
    if(!uploadedFile){ alert("Please upload a PDF first!"); return; }
    pdfPreviewContainer.classList.toggle('hidden');
});

// --- Tabs (UPDATED FOR NEW TAB) ---
const tabMap = { 
    'tab-extracted':'content-extracted', 
    'tab-attachments':'content-attachments', 
    'tab-tech':'content-tech', 
    'tab-commercial':'content-commercial',
    'tab-items-distributors':'content-items-distributors' 
};
Object.keys(tabMap).forEach(tabId => {
    document.getElementById(tabId).addEventListener('click', () => {
        Object.keys(tabMap).forEach(id => {
            document.getElementById(id).classList.remove('active');
            document.getElementById(tabMap[id]).classList.add('hidden');
        });
        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabMap[tabId]).classList.remove('hidden');
    });
});

// --- Analyze PDF ---
const analyzeBtn = document.getElementById('analyze-btn');
const analyzeLoader = document.getElementById('analyze-loader');
const analyzeStatus = document.getElementById('analyze-status');
const extractedDataContainer = document.getElementById('extracted-data');
let attachmentsFiles = {};
let mergedTPBlob = null, mergedCPBlob = null;

analyzeBtn.addEventListener('click', async ()=> {
    if(!uploadedFile){ alert("Please upload a PDF first!"); return; }
    extractedDataContainer.innerHTML = '';
    document.getElementById('items-distributors-container').innerHTML = ''; 
    analyzeLoader.style.display = 'inline-block';
    analyzeStatus.textContent = "Analyzing PDF...";
    const formData = new FormData();
    formData.append('pdf_file', uploadedFile);

    try{
        // NOTE: This fetch remains for analysis, as it is a complex AI task requiring the backend.
        const res = await fetch('/analyze',{method:'POST', body:formData});
        const data = await res.json();
        analyzeLoader.style.display = 'none';
        analyzeStatus.textContent="";
        if(data.error){ extractedDataContainer.innerHTML = `<div class='text-red-600'>Error: ${data.error}</div>`; return; }
        
        let aiOutput = data.extracted_data.raw_text || data.extracted_data;
        if(typeof aiOutput==='string'){ 
            aiOutput = aiOutput.replace(/^```json\s*|```$/g,''); 
            try{ 
                aiOutput = JSON.parse(aiOutput); 
            } catch(e){ 
                extractedDataContainer.innerHTML="<div class='text-red-600'>Could not parse AI output.</div>"; 
                return; 
            } 
        }

        renderTree(aiOutput);
        renderAttachmentTable(aiOutput);
        renderItemsAndDistributorsTab(aiOutput.required_items_needed || []);
        
    } catch(err){ 
        extractedDataContainer.innerHTML=`<div class='text-red-600'>Error: ${err.message}</div>`; 
        analyzeLoader.style.display = 'none'; 
        analyzeStatus.textContent=""; 
    }
});

// --- Tree Renderer (Original Extracted Data Tab) ---
function renderTree(data, parent = extractedDataContainer){
    parent.innerHTML = ''; // Clear previous data
    function createNode(key, value){
        const node = document.createElement('div'); node.className = 'tree-node';
        
        // FIX: Ensure key is a string before using replace()
        const displayKey = (typeof key === 'string') 
            ? key.replace(/_/g, ' ').toUpperCase() 
            : key;

        const keyEl = document.createElement('div'); 
        keyEl.className = 'tree-key'; 
        keyEl.textContent = displayKey; 
        
        node.appendChild(keyEl);
        
        if(value !== null && typeof value === 'object'){
            const childrenContainer = document.createElement('div'); 
            childrenContainer.style.marginLeft = '12px'; 
            childrenContainer.style.display = 'block'; 
            
            if(Array.isArray(value)){ 
                // key passed here is the index (a number)
                value.forEach((item,idx)=> childrenContainer.appendChild(createNode(idx+1,item))); 
            } else { 
                Object.entries(value).forEach(([k,v])=> childrenContainer.appendChild(createNode(k,v))); 
            }
            keyEl.addEventListener('click', ()=> { 
                childrenContainer.style.display = childrenContainer.style.display === 'none' ? 'block' : 'none'; 
            });
            node.appendChild(childrenContainer);
        } else { 
            const valEl = document.createElement('div'); 
            valEl.className = 'tree-value'; 
            valEl.textContent = value; 
            node.appendChild(valEl); 
        }
        return node;
    }
    Object.entries(data).forEach(([k,v]) => parent.appendChild(createNode(k,v)));
}

// --- NEW FUNCTION: Items & Distributors Tab ---
async function findDistributors(button, item) {
    const rowId = button.closest('tr').id.split('-')[2];
    const resultCell = document.getElementById(`distributor-results-${rowId}`);
    
    button.disabled = true;
    button.textContent = "Searching...";
    resultCell.innerHTML = '<span class="text-blue-500 text-sm">Searching the web via AI...</span>';

    try {
        const res = await fetch('/find_distributors', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_name: item, location: 'UAE' })
        });
        
        if (!res.ok) throw new Error(`Backend Error: ${res.statusText}`);
        
        const data = await res.json();
        
        if (data.error) {
            resultCell.innerHTML = `<span class="text-red-500 text-sm">AI Error: ${data.error}</span>`;
        } else if (data.distributors && data.distributors.length > 0) {
            let html = '<ul class="list-disc ml-4 space-y-1">';
            data.distributors.forEach(d => {
                // Ensure name and link exist before creating the element
                const distributorName = d.name || 'Unknown Distributor';
                const link = d.link ? `<a href="${d.link}" target="_blank" class="text-blue-600 hover:underline">Profile Link</a>` : 'No direct link';
                html += `<li><span class="font-semibold">${distributorName}</span> (${link})</li>`;
            });
            html += '</ul>';
            resultCell.innerHTML = html;
        } else {
            resultCell.innerHTML = `<span class="text-yellow-600 text-sm">No specific UAE distributors found.</span>`;
        }
    } catch (error) {
        console.error("Distributor search failed:", error);
        resultCell.innerHTML = `<span class="text-red-600 text-sm">Network/Server Error.</span>`;
    } finally {
        button.disabled = false;
        button.textContent = "Find Distributors";
    }
}

function renderItemsAndDistributorsTab(items) {
    const container = document.getElementById('items-distributors-container');
    container.innerHTML = `<h3 class="font-semibold mb-4 text-lg text-gray-800">Required Items and UAE Distributor Search</h3>`;
    
    if (items.length === 0) {
        container.innerHTML += `<p class="text-gray-500">No specific required items were extracted.</p>`;
        return;
    }
    
    const table = document.createElement('table');
    table.className = "w-full text-left border border-gray-300 rounded";
    table.innerHTML = `
        <thead class="bg-gray-100">
            <tr>
                <th class="p-2 border-b w-1/4">Item</th>
                <th class="p-2 border-b w-1/4">Action</th>
                <th class="p-2 border-b w-1/2">Distributors in UAE</th>
            </tr>
        </thead>
        <tbody id="distributor-table-body"></tbody>
    `;
    container.appendChild(table);
    const tableBody = document.getElementById('distributor-table-body');
    
    items.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.id = `item-row-${index}`;
        
        const itemName = item.name || item; // Handle both old and new format for safety
        const itemType = item.type || 'product'; // Default to product if type is missing

        const isNote = itemType === 'note';

        tr.innerHTML = `
            <td class="p-2 border-b">${itemName}</td>
            <td class="p-2 border-b">
                ${!isNote ? `
                <button 
                    class="find-distributor-btn bg-blue-600 text-white p-1 rounded text-sm hover:bg-blue-700 transition" 
                    data-item="${itemName}" 
                    onclick="findDistributors(this, '${itemName}')"
                >
                    Find Distributors
                </button>
                ` : ''}
            </td>
            <td class="p-2 border-b" id="distributor-results-${index}">
                ${!isNote ? `<span class="text-gray-500 text-sm">Click 'Find Distributors' to search.</span>` : ''}
            </td>
        `;
        tableBody.appendChild(tr);
    });
}


// --- Attachments Table --- 
function renderAttachmentTable(data){
    const tableBody = document.getElementById('attachments-table-body');
    const existingExtracted = tableBody.querySelectorAll('.extracted-attachment-row');
    existingExtracted.forEach(r => tableBody.removeChild(r));

    const attachmentsNeeded = data.attachments_needed || (data.requirements && data.requirements.attachments_needed);
    
    if(!attachmentsNeeded || attachmentsNeeded.length===0){ 
        if(tableBody.children.length === 0 || tableBody.children.length === tableBody.querySelectorAll('.extracted-attachment-row').length){
            tableBody.innerHTML = `<tr><td colspan="4" class="text-gray-500 p-2">No attachments required.</td></tr>`;
        }
        return; 
    }
    
    if (tableBody.children.length === 1 && tableBody.children[0].textContent.includes("No attachments required")) {
        tableBody.innerHTML = '';
    }

    attachmentsNeeded.forEach((item, idx) => {
        if (attachmentsFiles[item]) return;
        
        const tr = document.createElement('tr');
        tr.classList.add('extracted-attachment-row');
        
        const tdName = document.createElement('td'); tdName.className = "p-2 border-b"; tdName.textContent = item;
        
        const tdFile = document.createElement('td'); tdFile.className = "p-2 border-b"; 
        const input = document.createElement('input'); input.type='file'; 
        input.addEventListener('change', e=>{
            attachmentsFiles[item]=attachmentsFiles[item]||{};
            attachmentsFiles[item].file=e.target.files[0];
            updateProposals(); 
        });
        tdFile.appendChild(input);
        
        const tdTP = document.createElement('td'); tdTP.className="p-2 border-b text-center"; const tpCheck=document.createElement('input'); tpCheck.type='checkbox'; tpCheck.addEventListener('change',updateProposals); tdTP.appendChild(tpCheck);
        const tdCP = document.createElement('td'); tdCP.className="p-2 border-b text-center"; const cpCheck=document.createElement('input'); cpCheck.type='checkbox'; cpCheck.addEventListener('change',updateProposals); tdCP.appendChild(cpCheck);
        
        tr.appendChild(tdName); tr.appendChild(tdFile); tr.appendChild(tdTP); tr.appendChild(tdCP);
        tableBody.appendChild(tr);
        
        attachmentsFiles[item] = { file:null, tp:tpCheck, cp:cpCheck };
    });
}

// --- Prefill Attachments from Server ---
document.addEventListener('DOMContentLoaded', () => {
    const filesData = {{ files | tojson }};
    const tableBody = document.getElementById('attachments-table-body');

    if (!filesData || filesData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-gray-500 p-2">No default attachments found.</td></tr>`;
        return;
    }

    filesData.forEach(file => {
        const tr = document.createElement('tr');
        tr.className = 'default-attachment-row';

        const fileName = file.name;
        const fileId = file.id;

        const tdName = document.createElement('td');
        tdName.className = "p-2 border-b";
        tdName.textContent = fileName;
        tr.appendChild(tdName);

        const tdFile = document.createElement('td');
        tdFile.className = "p-2 border-b text-center";
        const editBtn = document.createElement('button');

        if (fileName.toLowerCase().endsWith('.pdf')) {
            editBtn.textContent = "View PDF";
        } else if (fileName.toLowerCase().endsWith('.docx')) {
            editBtn.textContent = "Edit & Attach";
        } else {
            editBtn.textContent = "Download";
        }

        editBtn.className = "download-btn";
        editBtn.dataset.fileId = file.id;
        editBtn.dataset.fileName = fileName;
        tdFile.appendChild(editBtn);
        tr.appendChild(tdFile);

        const tdTP = document.createElement('td');
        tdTP.className = "p-2 border-b text-center";
        const tpCheck = document.createElement('input');
        tpCheck.type = 'checkbox';
        tpCheck.dataset.fileId = fileId;
        tpCheck.dataset.fileName = fileName;
        tpCheck.addEventListener('change', handleDefaultAttachmentCheck);
        tdTP.appendChild(tpCheck);
        tr.appendChild(tdTP);

        const tdCP = document.createElement('td');
        tdCP.className = "p-2 border-b text-center";
        const cpCheck = document.createElement('input');
        cpCheck.type = 'checkbox';
        cpCheck.dataset.fileId = fileId;
        cpCheck.dataset.fileName = fileName;
        cpCheck.addEventListener('change', handleDefaultAttachmentCheck);
        tdCP.appendChild(cpCheck);
        tr.appendChild(tdCP);

        tableBody.appendChild(tr);
        attachmentsFiles[fileName] = { file: null, tp: tpCheck, cp: cpCheck, isLoading: false };

        editBtn.addEventListener('click', async () => {
            const fileId = editBtn.dataset.fileId;
            const currentFileName = editBtn.dataset.fileName;

            if (currentFileName.toLowerCase().endsWith('.pdf')) {
                window.open(`/download/file/${fileId}`, '_blank');
                return;
            }

            if (currentFileName.toLowerCase().endsWith('.docx')) {
                editBtn.disabled = true;
                editBtn.textContent = "Loading...";
                try {
                    const res = await fetch(`/download/docx/${fileId}`);
                    if (!res.ok) throw new Error(`Server Error: Failed to download DOCX. Status: ${res.status}`);
                    const arrayBuffer = await res.arrayBuffer();
                    const arr = new Uint8Array(arrayBuffer).subarray(0, 2);
                    if (arr[0] !== 0x50 || arr[1] !== 0x4B) throw new Error("Invalid file format. Expected a DOCX or ZIP file.");
                    const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                    quill.clipboard.dangerouslyPasteHTML(result.value);
                    currentEditingFileDetails = { name: currentFileName, id: fileId, btn: editBtn };
                    editorModal.classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    alert("Error: " + err.message);
                    editBtn.textContent = "Edit & Attach";
                } finally {
                    editBtn.disabled = false;
                    if (editBtn.textContent === "Loading...") editBtn.textContent = "Edit & Attach";
                }
                return;
            }

            window.location.href = `/download/file/${fileId}`;
        });
    });
});

async function handleDefaultAttachmentCheck(event) {
    const checkbox = event.target;
    const fileName = checkbox.dataset.fileName;
    const fileId = checkbox.dataset.fileId;
    const attachment = attachmentsFiles[fileName];

    if (checkbox.checked && !attachment.file && !attachment.isLoading) {
        attachment.isLoading = true;
        const loaderSpan = document.createElement('span');
        loaderSpan.className = 'loader ml-2';
        loaderSpan.style.display = 'inline-block';
        loaderSpan.style.width = '16px';
        loaderSpan.style.height = '16px';
        checkbox.parentElement.appendChild(loaderSpan);

        try {
            const res = await fetch(`/download/file/${fileId}`);
            if (!res.ok) throw new Error(`Failed to download file: ${res.statusText}`);
            const blob = await res.blob();
            attachment.file = new File([blob], fileName, { type: blob.type });
        } catch (error) {
            console.error('Error fetching attachment file:', error);
            checkbox.checked = false; 
        } finally {
            attachment.isLoading = false;
            checkbox.parentElement.removeChild(loaderSpan);
            updateProposals();
        }
    } else {
        updateProposals();
    }
}


// --- Custom Attachments ---
const addCustomBtn = document.getElementById('add-custom-attachment');
const customPopup = document.getElementById('custom-attachment-popup');
const customNameInput = document.getElementById('custom-attachment-name');
const customFileInput = document.getElementById('custom-attachment-file');
const customAddBtn = document.getElementById('custom-attachment-add');
const customCancelBtn = document.getElementById('custom-attachment-cancel');
addCustomBtn.addEventListener('click', ()=> customPopup.classList.remove('hidden'));
customCancelBtn.addEventListener('click', ()=> { customPopup.classList.add('hidden'); customNameInput.value=''; customFileInput.value=''; });
customAddBtn.addEventListener('click', ()=> {
    const name = customNameInput.value.trim();
    const file = customFileInput.files[0];
    if(!name || !file){ alert("Please provide name and file"); return; }
    
    const tableBody = document.getElementById('attachments-table-body');
    
    if (tableBody.children.length === 1 && tableBody.children[0].textContent.includes("No attachments required")) {
        tableBody.innerHTML = '';
    }

    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.className="p-2 border-b"; tdName.textContent=name;
    const tdFile = document.createElement('td'); tdFile.className="p-2 border-b";
    const input = document.createElement('input'); input.type='file'; input.files = customFileInput.files;
    tdFile.appendChild(input);
    const tdTP = document.createElement('td'); tdTP.className="p-2 border-b text-center"; const tpCheck=document.createElement('input'); tpCheck.type='checkbox'; tpCheck.addEventListener('change',updateProposals); tdTP.appendChild(tpCheck);
    const tdCP = document.createElement('td'); tdCP.className="p-2 border-b text-center"; const cpCheck=document.createElement('input'); cpCheck.type='checkbox'; cpCheck.addEventListener('change',updateProposals); tdCP.appendChild(cpCheck);
    tr.appendChild(tdName); tr.appendChild(tdFile); tr.appendChild(tdTP); tr.appendChild(tdCP);
    tableBody.appendChild(tr);
    attachmentsFiles[name] = { file:file, tp:tpCheck, cp:cpCheck };
    customPopup.classList.add('hidden'); customNameInput.value=''; customFileInput.value='';
    updateProposals();
});

// --- Drag & Drop, Remove, Merge, Download ---
function makeRemovable(containerId){
    const container = document.getElementById(containerId);
    container.addEventListener('click', e=>{
        if(e.target.classList.contains('remove-btn')){
            const attName = e.target.dataset.name;
            const parentDiv = e.target.parentElement;
            if (parentDiv && parentDiv.classList.contains('draggable-file')) {
                container.removeChild(parentDiv);
            }
            if(attachmentsFiles[attName]){
                if (attachmentsFiles[attName].tp) attachmentsFiles[attName].tp.checked = false;
                if (attachmentsFiles[attName].cp) attachmentsFiles[attName].cp.checked = false;
            }
            updateProposals();
        }
    });
}
makeRemovable('tp-selected-files');
makeRemovable('cp-selected-files');

function updateProposals(){
    const tpDiv = document.getElementById('tp-selected-files'); 
    const tpIframe = document.getElementById('tp-merged-iframe');
    const cpDiv = document.getElementById('cp-selected-files'); 
    const cpIframe = document.getElementById('cp-merged-iframe');

    function getCurrentOrder(container){ return [...container.querySelectorAll('.draggable-file')].map(d => d.dataset.name); }
    const tpOrder = getCurrentOrder(tpDiv);
    const cpOrder = getCurrentOrder(cpDiv);

    tpDiv.innerHTML="<h3 class='font-semibold mb-2'>Selected Files (Drag to Reorder)</h3>"; 
    cpDiv.innerHTML="<h3 class='font-semibold mb-2'>Selected Files (Drag to Reorder)</h3>";
    const tpFiles=[]; const cpFiles=[];

    for(const [name,obj] of Object.entries(attachmentsFiles)){
        if(obj.file){
            if(obj.tp && obj.tp.checked) tpFiles.push({name:name, file:obj.file});
            if(obj.cp && obj.cp.checked) cpFiles.push({name:name, file:obj.file});
        }
    }

    function renderDraggableFiles(files, container, previousOrder=[]){
        files.sort((a,b)=>{
            const aIndex = previousOrder.indexOf(a.name);
            const bIndex = previousOrder.indexOf(b.name);
            if(aIndex===-1 && bIndex===-1) return 0;
            if(aIndex===-1) return 1;
            if(bIndex===-1) return -1;
            return aIndex - bIndex;
        });
        
        files.forEach(f=>{
            const div = document.createElement('div');
            div.className='draggable-file flex justify-between items-center';
            div.setAttribute('draggable','true');
            div.dataset.name=f.name;
            
            const span = document.createElement('span'); span.textContent=f.name;
            const removeBtn = document.createElement('button'); 
            removeBtn.textContent='✕'; 
            removeBtn.className='remove-btn ml-2 text-red-600 font-bold';
            removeBtn.dataset.name=f.name;
            
            div.appendChild(span); div.appendChild(removeBtn);
            container.appendChild(div);
            
            div.addEventListener('dragstart', e=> div.classList.add('dragging'));
            div.addEventListener('dragend', e=>{ div.classList.remove('dragging'); updateProposals(); });
        });
        
        container.addEventListener('dragover', e=>{
            e.preventDefault();
            const dragging = container.querySelector('.dragging');
            if(!dragging) return;
            const elements = [...container.querySelectorAll('.draggable-file:not(.dragging)')];
            const afterElement = elements.reduce((closest, child)=>{
                const box = child.getBoundingClientRect();
                const offset = e.clientY - (box.top + box.height/2);
                if(offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
            if(!afterElement) container.appendChild(dragging); else container.insertBefore(dragging, afterElement);
        });
    }

    renderDraggableFiles(tpFiles,tpDiv,tpOrder);
    renderDraggableFiles(cpFiles,cpDiv,cpOrder);

    async function mergeFiles(files){
        if(files.length===0) return null;
        const mergedPdf = await PDFLib.PDFDocument.create();
        for(const f of files){
            if (!f.file) continue;
            const bytes = await f.file.arrayBuffer();
            try {
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                copiedPages.forEach(p=> mergedPdf.addPage(p));
            } catch (error) {
                console.error(`Skipping file ${f.name} due to PDF loading error:`, error);
            }
        }
        if (mergedPdf.getPageCount() === 0) return null;
        const mergedBytes = await mergedPdf.save();
        return new Blob([mergedBytes], {type:'application/pdf'});
    }

    Promise.resolve(mergeFiles(tpFiles)).then(blob => {
        mergedTPBlob = blob;
        tpIframe.src = blob ? URL.createObjectURL(blob) : "";
    });

    Promise.resolve(mergeFiles(cpFiles)).then(blob => {
        mergedCPBlob = blob;
        cpIframe.src = blob ? URL.createObjectURL(blob) : "";
    });
}

// --- Download ---
document.getElementById('tp-download').addEventListener('click', async ()=>{
    if(!mergedTPBlob) return alert("No TP merged file");
    const blob = await mergedTPBlob;
    if(!blob) return alert("Failed to merge Technical Proposal files.");
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="Technical_Proposal.pdf"; a.click();
});
document.getElementById('cp-download').addEventListener('click', async ()=>{
    if(!mergedCPBlob) return alert("No CP merged file");
    const blob = await mergedCPBlob;
    if(!blob) return alert("Failed to merge Commercial Proposal files.");
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="Commercial_Proposal.pdf"; a.click();
});




</script>
{% endblock %}