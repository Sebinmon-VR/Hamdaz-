{% extends "base.html" %}

{% block content %}

<div class="user_dashboard">
    <h3 style="margin-top: 20px; font-size: 20px ; margin-bottom: 5px; margin-left: 35px;">{{greeting}} {{user.displayName}} !</h3>
    <p style=" margin-bottom: 5px; margin-left: 35px;">{{due_today_tasks_count}} dues today , {{ongoing_tasks_count}} ongoing </p>

    <div class="analytics_items"
        style="width: 100%; height: 100px; background: #eaeaea00; margin: 0 auto; display: flex; align-items: center; margin-top :30px;  ">

        <div class="card_a"
            style="box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width:200px; height: 80px; background: #ffffff; margin: 10px;margin-left: 35px; padding: 10px; border-radius: 5px;  text-align: center;">
            <h6 style="font-size: 17px; font-weight: bold;">{{user_analytics.TotalTasks}}</h6>
            <p>Total Tasks</p>
        </div>

        <div class="card_a"
            style="box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width:200px; height: 80px; background: #ffffff; margin: 10px;margin-left: 35px; padding: 10px; border-radius: 5px;  text-align: center;">
            <h6 style="font-size: 17px; font-weight: bold;">{{ongoing_tasks_count}}</h6>
            <p>Pending</p>
        </div>

        <div class="card_a"
            style="box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width:200px; height: 80px; background: #ffffff; margin: 10px;margin-left: 35px; padding: 10px; border-radius: 5px;  text-align: center;">
            <h6 style="font-size: 17px; font-weight: bold;">{{user_analytics.CompletedTasksCount}}</h6>
            <p>Completed</p>
        </div>

        <div class="card_a"
            style="box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width:200px; height: 80px; background: #ffffff; margin: 10px;margin-left: 35px; padding: 10px; border-radius: 5px;  text-align: center;">
            <h6 style="font-size: 17px; font-weight: bold;">{{user_analytics.MissedTasksCount}}</h6>
            <p>Missed</p>
        </div>

        <div class="card_a"
            style="box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width:200px; height: 80px; background: #ffffff; margin: 10px;margin-left: 35px; padding: 10px; border-radius: 5px;  text-align: center;">
            <h6 style="font-size: 17px; font-weight: bold;">{{user_analytics.OrdersReceived}}</h6>
            <p>Orders Received</p>
        </div>

    </div>

    <div class="second_section" style="width: 100%; display: flex; gap: 20px; align-items: flex-start; margin-top: 30px;">

        <!-- Active tasks column (lists scroll independently) -->
        <div class="active_tasks"
            style="width: 45%; margin-left: 30px; background: #ffffff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 20px; border-radius: 6px;">
            
            <div class="due_today">
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Due Today</h4>
                {% if due_today_tasks_count == 0 %}
                    <p style="color: #888;">No tasks due today.</p>
                {% else %}
                    <!-- make this list scrollable -->
                    <ul style="list-style-type: none; padding: 0; margin: 0; max-height: 160px; overflow-y: auto; padding-right: 8px;">
                        {% for task in user_analytics.DueTodayTasks %}
                        <li style="background: #f9f9f9; margin-bottom: 10px; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);">
                            <a href="{{ url_for('task_details', title=task.Title) }}" style="text-decoration: none; color: inherit;">
                                <strong>{{ task.Title }}</strong><br>
                                Due: {{ task.DueDate }}<br>
                                Status: {{ task.Status }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="on_going" style="margin-top: 18px;">
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Ongoing Tasks</h4>
                {% if ongoing_tasks_count == 0 %}
                    <p style="color: #888;">No ongoing tasks.</p>
                {% else %}
                    <!-- make this list scrollable -->
                    <ul style="list-style-type: none; padding: 0; margin: 0; max-height: 160px; overflow-y: auto; padding-right: 8px;">
                        {% for task in user_analytics.OngoingTasks %}
                        <li style="background: #f9f9f9; margin-bottom: 10px; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);">
                            <a href="{{ url_for('task_details', title=task.Title) }}" style="text-decoration: none; color: inherit;">
                                <strong>{{ task.Title }}</strong><br>
                                Due: {{ task.DueDate }}<br>
                                Status: {{ task.Status }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

        </div>

        <!-- Performance column (keeps original look) -->
        <div class="performance"
            style="width: 45%; margin-left: 0; background: #ffffff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); padding: 20px; border-radius: 6px;">
            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Performance Overview</h4>
            {% set total_tasks = user_analytics.TotalTasks %}
            {% set completed = user_analytics.CompletedTasksCount %}
            {% set missed = user_analytics.MissedTasksCount %}
            {% if total_tasks > 0 %}
                {% set performance_score = ((completed) / total_tasks) * 100 %}
            {% else %}
                {% set performance_score = 0 %}
            {% endif %}

            <div style="display: flex; align-items: center; height: 100%;">
                <svg width="110" height="110" viewBox="0 0 110 110">
                    <circle cx="55" cy="55" r="45" stroke="#e6e6e6" stroke-width="10" fill="none" />
                    <circle cx="55" cy="55" r="45" stroke="#4caf50" stroke-width="10" fill="none"
                        stroke-dasharray="282.74"
                        stroke-dashoffset="{{ 282.74 - (performance_score / 100.0 * 282.74) }}" stroke-linecap="round"
                        transform="rotate(-90 55 55)" />
                    <text x="50%" y="54%" text-anchor="middle" dy=".3em" font-size="22" font-family="Arial" fill="#333">
                        {{ performance_score|round|int }}%
                    </text>
                </svg>
                <div style="margin-left: 25px;">
                    <div style="font-size: 15px; font-weight: 500;">
                        {{ completed }} tasks submitted<br>
                        {{ missed }} missed<br>
                        {{ total_tasks }} total
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="user_tasks" style="width: 100%; background: #ffffff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-top: 30px; padding-bottom: 20px;">
        <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 10px; margin-left: 35px; margin-top: 20px;">All Tasks</h4>
        {% if user_analytics.user_tasks|length == 0 %}
            <p style="color: #888; margin-left: 35px;">No tasks assigned.</p>
        {% else %}
            <table style="width: 90%; margin-left: 35px; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Title</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Due Date</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Status</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; text-align: left;">Priority</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in user_analytics.user_tasks %}
                    <tr class="clickable-row" data-href="{{ url_for('task_details', title=task.Title) }}">
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ task.Title }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ task.DueDate }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ task.Status }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ task.Priority }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

</div>

<!-- JS to make table rows clickable -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".clickable-row").forEach(function(row) {
        row.addEventListener("click", function() {
            window.location.href = row.dataset.href;
        });
        row.style.cursor = "pointer";
    });
});
</script>

{% endblock %}
